<!DOCTYPE html>
<html lang="zh_CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator By Wink Zhang</title>
    <script>
        const key = ["C", "+/-", "%", "÷", "7", "8", "9", "x", "4", "5", "6", "-", "1", "2", "3", "+", "0", ".", "="];
        const precedenceLevel = {
            "+": 1,
            "-": 1,
            "x": 2,
            "÷": 2,
            "~": 3,
            "%": 3,
        };
        window.onload = () => {
            generateKeyboard();
        }
        // 全局变量。
        // 表达式。
        let expression = "";
        // 输出格式化表达式
        let outputExpression = "";
        // 正负号，当 plusMinus 为1时，为正数。
        let plusMinus = 1;

        function generateKeyboard() {
            key.forEach((e, i) => {
                let element = document.createElement("div");
                element.innerText = e;
                switch (e) {
                    case 'C': element.onclick = () => { removeValue(); }; break;
                    case "AC": element.onclick = () => { cleanValue(); }; break;
                    case "+/-": element.onclick = () => { changeValue(); }; break;
                    case "=": element.onclick = () => { flush(); }; break;
                    default: element.onclick = () => { inputValue(e); }
                }
                if (e == 'C' || e == "+/-" || e == '%') {
                    element.classList.add('key_grey');
                }
                else if (e == '÷' || e == "x" || e == "-" || e == "+" || e == "=") {
                    element.classList.add("key_yellow");
                }
                else {
                    element.classList.add("key_default")
                }
                element.id = 'key_' + e;
                $("keyboard").append(element);
            })

        }
        function changeValue() {
            if (expression[expression.length - 1] == '~') {
                expression = expression.substring(0, expression.length - 1);
            }
            else
                expression += '~';
        }
        function inputValue(value) {
            if (expression.length < 13)
                expression += value
            $("cal_input").innerText = expression;
        }
        function removeValue() {
            let value = expression.substring(0, expression.length - 1);
            expression = value ? value : "";
            $("cal_input").innerText = expression;
        }
        function cleanValue() {
            expression = "";
            $("cal_input").innerText = expression;
        }
        function flush() {
            let result = exportAnswer();
            $("cal_output").innerText = result;
        }
        function $(id) {
            return document.getElementById(id);
        }
        // 判断一个字符是不是数字
        function isNum(num) {
            return /^[0-9]+.?[0-9]*$/.test(num) || num.includes(".");
        }
        // 计算结果
        function calculate(operator, character1, character2) {
            let num1 = Number.parseFloat(character1); //last in
            let num2 = Number.parseFloat(character2); //first in
            let sum = 0;
            switch (operator) {
                case "+":
                    sum = num2 + num1;
                    break;
                case "-":
                    sum = num2 - num1;
                    break;
                case "x":
                    sum = num2 * num1;
                    break;
                case "÷":
                    sum = num2 / num1;
                    break;
            }
            return sum;
        }
        function exportAnswer() {
            let expressionArray = expression.split("");
            let numStack = [];
            let operatorStack = [];
            // 如果第一个输入的就是 + / 那么就 第一个数字为0
            // 循环扫描表达式入栈。
            let character = "";
            for (let i = 0; i < expressionArray.length; i++) {
                character += expressionArray[i];
                if (isNum(character)) {
                    if (i + 1 < expressionArray.length && isNum(expressionArray[i + 1])) {
                        continue;
                    } else {
                        numStack.push(Number.parseFloat(character));
                        character = "";
                    }
                } else {
                    if (operatorStack.length == 0) {
                        operatorStack.push(character);
                    } else {
                        if (
                            precedenceLevel[character] <=
                            precedenceLevel[operatorStack[operatorStack.length - 1]]
                        ) {
                            if (operatorStack[operatorStack.length - 1] == '~') {
                                numStack.push(-numStack.pop());
                                operatorStack.pop();
                            }
                            else if (operatorStack[operatorStack.length - 1] == '%') {
                                numStack.push(numStack.pop() / 100);
                                operatorStack.pop();
                            }
                            else {
                                numStack.push(
                                    calculate(operatorStack.pop(), numStack.pop(), numStack.pop())
                                );
                            }
                            operatorStack.push(character);
                        } else operatorStack.push(character);
                    }
                    character = "";
                }
            }
            // 扫描完成后取剩余操作数。
            for (let i = operatorStack.length - 1; i >= 0; i--) {
                if (operatorStack[operatorStack.length - 1] == '~') {
                    numStack.push(-numStack.pop());
                    operatorStack.pop();
                }
                else if (operatorStack[operatorStack.length - 1] == '%') {
                    numStack.push(numStack.pop() / 100);
                    operatorStack.pop();
                }
                else {
                    numStack.push(calculate(operatorStack[i], numStack.pop(), numStack.pop()));
                }
            }
            return numStack[0]
        }
    </script>
</head>

<body>
    <div class="cal_container">
        <div class="top_container">
            <div>
                中国移动
            </div>
            <div>
                9:00
            </div>
            <div>
                20%
            </div>
        </div>
        <div class="value_container">
            <div id="cal_input"></div>
            <div id="cal_output"></div>
        </div>
        <div id="keyboard"></div>
    </div>
</body>
<style>
    body {
        margin: 0px;
        padding: 0px;
        background-color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .cal_container {
        background-color: black;
        padding: 0.5rem;
        border-radius: 0.5rem;
        margin-top: 30px;
        width: 16.5rem;
        height: 32rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        box-shadow: grey 3px 3px 10px;
        margin-bottom: 30px;
    }

    .value_container {
        flex: 1;
        display: flex;
        color: white;
        text-align: end;
        font-size: 1.5rem;
        flex-direction: column;
        width: 17.5rem;
    }

    .top_container {
        display: flex;
        height: 1rem;
        color: white;
        width: 100%;
        margin-left: 0.5rem;
        margin-right: 0.5rem;
    }

    .top_container :nth-child(2) {
        flex: 1;
        text-align: center;
        position: relative;
        right: 0.4rem;
    }

    .top_container>div {
        font-size: 0.5rem;
        font-weight: 500;
        height: 1rem;
    }

    .value_container>div {
        flex: 1;
        font-size: 3rem;
        padding-left: 1rem;
        padding-right: 1rem;
        width: 15.5rem;
        white-space: nowrap;
    }

    #keyboard {
        display: grid;
        grid-template-columns: 3.5rem 3.5rem 3.5rem 3.5rem;
        grid-row-gap: 0.5rem;
        grid-column-gap: 0.5rem;
        height: 20rem;
        margin-top: 1.5rem;
    }

    #keyboard>div {
        width: 3.5rem;
        height: 3.5rem;
        border-radius: 2rem;
        font-size: 1.3rem;
        text-align: center;
        line-height: 3.5rem;
        font-weight: 600;
    }

    #keyboard>div:active {
        background-color: cornsilk;
    }

    .key_grey {
        color: black;
        background-color: #a6a6a6;
    }

    .key_grey:hover {
        background-color: #d9d9d9;
    }

    .key_yellow {
        background-color: #ff9f0a;
        color: white;
    }

    .key_yellow:hover {
        background-color: #fcc78d;
    }

    .key_default {
        background-color: #323333;
        color: white;
    }

    .key_default:hover {
        background-color: #737373;
    }

    #key_\+\/- {
        font-size: 1rem !important;
        font-weight: 700;
    }

    #key_x {
        font-size: 1.2rem !important;
    }

    #key_0 {
        grid-column: span 2;
        width: 6rem !important;
        text-align: left !important;
        padding-left: 1.5rem;
    }
</style>

</html>